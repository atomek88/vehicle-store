# Junkyard Tracker - Project Plan

> This project plan outlines the development roadmap for the Junkyard Tracker application, following an Epic -> Story -> Task hierarchy. It is based on the technical design and implementation guide.

## References & Callouts

- **Design Documents:** [SUMMARY.md](./SUMMARY.md), [TECHNICAL_DESIGN.md](./TECHNICAL_DESIGN.md), [IMPLEMENTATION_GUIDE.md](./IMPLEMENTATION_GUIDE.md)
- **Engineering Principles:** SOLID design, DRY, modularity, and maintainability.
- **Testing Philosophy:** A comprehensive, multi-layered testing strategy (Unit, Integration, E2E) is integral to every story.

---

## EPIC 1: Core Application Setup & Foundation

> **Goal:** Initialize the project, configure the development environment, and establish the foundational types and validation schemas that will drive the entire application.

### Story 1.1: Project Initialization

- **Description:** Set up the Next.js project with all required dependencies and configurations for TypeScript, Tailwind CSS, and ESLint.
- **Tasks:**
  - [ ] Initialize Next.js project using `create-next-app`.
  - [ ] Install production dependencies: `react-hook-form`, `@hookform/resolvers`, `zod`, `uuid`, `clsx`, `tailwind-merge`.
  - [ ] Install development dependencies: `vitest`, `@vitest/ui`, `@testing-library/react`, `playwright`, `@types/uuid`, etc.
  - [ ] Configure `tsconfig.json` with strict settings (`strict: true`, `noUncheckedIndexedAccess`).
  - [ ] Configure `tailwind.config.ts`.
  - [ ] Configure `eslint.config.mjs` with rules for exhaustive checks and unused variables.

### Story 1.2: Domain Modeling (Types)

- **Description:** Define all core TypeScript types for the application domain in a centralized `types/index.ts` file.
- **Tasks:**
  - [ ] Create `src/types/index.ts`.
  - [ ] Define and export literal types for enums (`VEHICLE_TYPES`, `ENGINE_STATUSES`, etc.).
  - [ ] Define and export the `Registration` discriminated union (`registered` | `failed`).
  - [ ] Define `VehicleBase` interface.
  - [ ] Define and export vehicle-specific interfaces (`Sedan`, `Coupe`, `MiniVan`, `Motorcycle`).
  - [ ] Define and export the main `Vehicle` discriminated union.
  - [ ] Define and export the generic `Result<T, E>` type for error handling.
  - [ ] Define and export state management types (`VehicleState`, `VehicleFilters`, etc.).

### Story 1.3: Validation Schema Definition

- **Description:** Create a comprehensive set of Zod schemas for validating form inputs and persisted data structures.
- **Tasks:**
  - [ ] Create `src/validations/schemas.ts`.
  - [ ] Implement primitive schemas (`NicknameSchema`, `MileageSchema`).
  - [ ] Implement vehicle-specific schemas (`CarWheelsSchema`, `CoupeDoorsSchema`).
  - [ ] Implement `RegistrationSchema` discriminated union.
  - [ ] Implement `VehicleFormInputSchema` discriminated union for form inputs.
  - [ ] Implement `VehiclePersistedSchema` discriminated union for data storage, including `superRefine` for complex rules like the Mini-van `doorConfig`.
  - [ ] Implement the top-level `StorageSchemaV1` for versioning data in localStorage.

### Story 1.4: Base Testing Setup

- **Description:** Configure the testing frameworks (Vitest and Playwright) and create initial test files.
- **Tasks:**
  - [ ] Create and configure `vitest.config.ts`.
  - [ ] Create `tests/setup.ts` to mock `localStorage` and `crypto.randomUUID`, and include test cleanup logic.
  - [ ] Create and configure `playwright.config.ts`, including the web server command.
  - [ ] Run `npx playwright install` to install browser dependencies.
  - [ ] Write initial unit tests for Zod schemas in `src/validations/schemas.test.ts` to validate the testing setup.

---

## EPIC 2: Vehicle Data Persistence & Services

> **Goal:** Develop the business logic and data handling layers, encapsulating all operations related to vehicle creation, registration, and storage.

### Story 2.1: LocalStorage Repository

- **Description:** Create a repository to handle the serialization, saving, and loading of vehicle data to and from the browser's localStorage.
- **Tasks:**
  - [ ] Create `src/lib/storage.ts`.
  - [ ] Implement `save` function to serialize the state to JSON using `StorageSchemaV1` and save to localStorage.
  - [ ] Implement `load` function to read from localStorage, parse, and validate the data against `StorageSchemaV1`.
  - [ ] Implement `clear` function to remove data.
  - [ ] Implement robust error handling for parsing and validation failures.
  - [ ] Write unit tests for all repository functions in `src/lib/storage.test.ts`.

### Story 2.2: Registration Service

- **Description:** Implement the deterministic logic for vehicle registration, including success and failure scenarios.
- **Tasks:**
  - [ ] Create `src/lib/registration-service.ts`.
  - [ ] Implement `attemptRegistration` function with deterministic failure rules (nickname patterns, mileage limit).
  - [ ] Implement dev toggle functionality (`isForceFailEnabled`, `setForceFailEnabled`).
  - [ ] Implement `generateRegistrationId` utility.
  - [ ] Write comprehensive unit tests for the registration service in `src/lib/registration-service.test.ts`.

### Story 2.3: Vehicle Service

- **Description:** Create the main service layer for orchestrating vehicle CRUD operations.
- **Tasks:**
  - [ ] Create `src/lib/vehicle-service.ts`.
  - [ ] Implement `createVehicle` function, coordinating validation, defaults, uniqueness checks, and registration.
  - [ ] Implement `updateVehicle` function, ensuring type and registration immutability.
  - [ ] Implement `deleteVehicle` function (if logic is needed beyond a simple filter).
  - [ ] Implement helper functions for default values (`applyDefaults`, `reconcileDoorConfig`) in `src/lib/defaults.ts`.
  - [ ] Write unit tests for the vehicle service in `src/lib/vehicle-service.test.ts`.

---

## EPIC 3: State Management & UI Hooks

> **Goal:** Build the client-side state management infrastructure to hold and manage the vehicle inventory, filters, and sorting.

### Story 3.1: Vehicle State Reducer

- **Description:** Create a `useReducer` hook to manage the `VehicleState`.
- **Tasks:**
  - [ ] Create `src/hooks/use-vehicles.tsx`.
  - [ ] Define the `VehicleAction` discriminated union for all state transitions (CRUD, filters, sorting, hydration).
  - [ ] Implement the `vehicleReducer` function with a `switch` statement covering all actions.
  - [ ] Define the initial state for the reducer.
  - [ ] Write unit tests for the reducer logic in `src/hooks/use-vehicles.test.tsx`.

### Story 3.2: Vehicle Context Provider

- **Description:** Create a React Context to provide the vehicle state and dispatch function to the component tree.
- **Tasks:**
  - [ ] In `src/hooks/use-vehicles.tsx`, create `VehicleStateContext` and `VehicleDispatchContext`.
  - [ ] Create the `VehicleProvider` component.
  - [ ] Implement `useEffect` in the provider to handle initial data hydration from the `vehicleRepository`.
  - [ ] Implement `useEffect` to automatically save state back to the repository on changes.
  - [ ] Implement memoized selectors (`selectFilteredVehicles`) to compute derived data.

### Story 3.3: UI Hooks

- **Description:** Develop custom hooks for interacting with the UI, such as displaying notifications.
- **Tasks:**
  - [ ] Create `src/hooks/use-toast.tsx` for managing toast notifications.
  - [ ] Create the `ToastProvider` and associated context.

---

## EPIC 4: Vehicle CRUD User Interface

> **Goal:** Build all the React components and pages required for users to view, create, edit, and delete vehicles.

### Story 4.1: Core UI Components

- **Description:** Create the set of generic, reusable UI components that will be used throughout the application.
- **Tasks:**
  - [ ] Create `Button.tsx`, `Input.tsx`, `Select.tsx`, `Badge.tsx` in `src/components/ui/`.
  - [ ] Create `Toast.tsx` and `ConfirmDialog.tsx` for notifications and confirmations.
  - [ ] Create a barrel export file `src/components/ui/index.ts`.

### Story 4.2: Vehicle List View

- **Description:** Develop the main dashboard for displaying, filtering, and sorting the list of vehicles.
- **Tasks:**
  - [ ] Create the `VehicleTable.tsx` component with responsive columns.
  - [ ] Create the `FiltersBar.tsx` component for search and filter controls.
  - [ ] Create feature-specific badges like `RegistrationBadge.tsx` and `MileageRatingBadge.tsx`.
  - [ ] Assemble the components into the dashboard page at `src/app/vehicles/page.tsx`.
  - [ ] Connect the page to the `useVehicles` hook to display and filter data.

### Story 4.3: Vehicle Form & Creation

- **Description:** Build the vehicle form for creating and editing vehicles, including dynamic fields for each vehicle type.
- **Tasks:**
  - [ ] Create type-specific field components: `SedanFields.tsx`, `CoupeFields.tsx`, etc. in `src/components/vehicles/fields/`.
  - [ ] Create the main `VehicleForm.tsx` component using `react-hook-form` and the `zodResolver`.
  - [ ] Implement logic to dynamically render the correct fields based on the selected vehicle type.
  - [ ] Create the `Create Vehicle` page at `src/app/vehicles/new/page.tsx`.
  - [ ] Implement the submission logic, calling the `vehicleService` and dispatching state updates.

### Story 4.4: Vehicle Details & Edit View

- **Description:** Create the pages for viewing the details of a single vehicle and for editing it.
- **Tasks:**
  - [ ] Create the vehicle details page at `src/app/vehicles/[id]/page.tsx`.
  - [ ] Create the `Edit Vehicle` page at `src/app/vehicles/[id]/edit/page.tsx`, pre-filling the `VehicleForm` with existing data.
  - [ ] Implement the update and delete logic on the respective pages.

---

## EPIC 5: Testing & Quality Assurance

> **Goal:** Ensure the application is robust and bug-free by implementing a comprehensive, multi-layered testing strategy.

### Story 5.1: Unit & Component Tests

- **Description:** Write unit tests for all critical business logic and component rendering.
- **Tasks:**
  - [ ] Write unit tests for all service functions (already started in Epic 2).
  - [ ] Write unit tests for all Zod schemas (already started in Epic 1).
  - [ ] Write unit tests for the `vehicleReducer` (already started in Epic 3).
  - [ ] Write component tests for `VehicleForm.tsx` and `VehicleTable.tsx` to verify rendering and basic interactions.

### Story 5.2: Integration Tests

- **Description:** Create integration tests to verify that different layers of the application work together correctly.
- **Tasks:**
  - [ ] Create `tests/integration/vehicle-crud.spec.ts`.
  - [ ] Write tests for the full CRUD flow, from service call to storage, ensuring data integrity.
  - [ ] Write tests for nickname uniqueness enforcement and storage corruption recovery.
  - [ ] Create `tests/integration/registration-flow.spec.ts` to test registration variations.

### Story 5.3: End-to-End (E2E) Tests

- **Description:** Use Playwright to simulate full user journeys through the application.
- **Tasks:**
  - [ ] Create `tests/e2e/create-vehicle.spec.ts` to test the creation flow for each vehicle type.
  - [ ] Create `tests/e2e/edit-vehicle.spec.ts` to test the vehicle editing flow.
  - [ ] Create `tests/e2e/delete-vehicle.spec.ts` to test the deletion flow, including the confirmation dialog.
  - [ ] Create `tests/e2e/filters.spec.ts` to test the search, filter, and sort functionality on the dashboard.

---

## EPIC 6: UI Polish & Finalization

> **Goal:** Refine the user experience, add final touches, and ensure the application is visually appealing and easy to use.

### Story 6.1: Responsive Design Refinements

- **Description:** Ensure the application is fully responsive and looks great on desktop and tablet screen sizes.
- **Tasks:**
  - [ ] Review and test the `VehicleTable` on smaller viewports, ensuring horizontal scroll works as expected.
  - [ ] Test the `FiltersBar` layout, ensuring it stacks correctly.
  - [ ] Test the `VehicleForm` layout, ensuring it transitions from two columns to one gracefully.
  - [ ] Add loading states and spinners for data hydration and form submissions.

### Story 6.2: Notifications & Feedback

- **Description:** Implement clear user feedback for all actions.
- **Tasks:**
  - [ ] Integrate the `useToast` hook to show success/error notifications for create, update, and delete actions.
  - [ ] Show form-level error banners for business rule violations (e.g., nickname taken).
  - [ ] Implement the confirmation dialog for the delete action.
  - [ ] Implement a graceful error recovery UI for data hydration failures.
